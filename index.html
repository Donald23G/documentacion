<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documentaci√≥n T√©cnica: Sistema de Gestiones CRM Inmobiliario</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        @page {
            size: A4;
            margin: 2cm;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            color: #1a1a1a;
            background: white;
            font-size: 14px;
        }

        .container {
            max-width: 210mm;
            margin: 0 auto;
            padding: 25px;
            background: white;
        }

        /* Portada */
        .cover {
            height: 297mm;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            page-break-after: always;
            background: linear-gradient(135deg, #9f9fa1 0%, hsl(220, 9%, 61%) 100%);
            color: rgb(3, 51, 122);
            padding: 50px;
            position: relative;
            overflow: hidden;
        }

        .cover::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="white" fill-opacity="0.05"><rect x="0" y="0" width="100" height="100"/></svg>');
        }

        .cover h1 {
            font-size: 42px;
            margin-bottom: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
            position: relative;
            z-index: 1;
        }

        .cover .subtitle {
            font-size: 22px;
            margin-bottom: 40px;
            opacity: 0.9;
            font-weight: 400;
            position: relative;
            z-index: 1;
        }

        .cover .info {
            margin-top: 80px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 1;
        }

        .cover .info p {
            margin: 12px 0;
            display: flex;
            justify-content: space-between;
            max-width: 400px;
        }

        .cover .info strong {
            font-weight: 600;
            margin-right: 20px;
            min-width: 120px;
            text-align: right;
        }

        /* Tabla de contenidos */
        .toc {
            page-break-after: always;
            padding: 50px 0 30px;
        }

        .toc h2 {
            font-size: 28px;
            color: #1e3a8a;
            margin-bottom: 30px;
            padding-bottom: 12px;
            border-bottom: 2px solid #2563eb;
            font-weight: 600;
        }

        .toc ul {
            list-style: none;
            padding: 0;
        }

        .toc li {
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }

        .toc li:hover {
            background: #f8fafc;
            padding-left: 10px;
        }

        .toc a {
            color: #374151;
            text-decoration: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 15px;
        }

        .toc a:hover {
            color: #2563eb;
        }

        .toc a::after {
            content: '';
            flex: 1;
            border-bottom: 1px dotted #d1d5db;
            margin: 0 15px;
            order: 2;
        }

        .toc a span:first-child {
            order: 1;
        }

        .toc a span:last-child {
            order: 3;
            color: #6b7280;
            font-variant-numeric: tabular-nums;
        }

        /* Secciones */
        .section {
            page-break-before: always;
            padding: 40px 0;
        }

        .section:first-of-type {
            page-break-before: avoid;
        }

        h1 {
            font-size: 32px;
            color: #1e3a8a;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #2563eb;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        h2 {
            font-size: 24px;
            color: #1e40af;
            margin: 35px 0 18px;
            padding-top: 8px;
            font-weight: 600;
        }

        h3 {
            font-size: 18px;
            color: #374151;
            margin: 28px 0 14px;
            font-weight: 600;
        }

        h4 {
            font-size: 16px;
            color: #4b5563;
            margin: 22px 0 12px;
            font-weight: 600;
        }

        p {
            margin: 14px 0;
            text-align: justify;
            color: #4b5563;
        }

        /* Tablas */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            font-size: 14px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }

        th {
            background: #1e3a8a;
            color: white;
            padding: 14px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
            vertical-align: top;
        }

        tr:nth-child(even) {
            background: #f8fafc;
        }

        tr:hover {
            background: #f0f9ff;
        }

        /* C√≥digo */
        code {
            background: #f3f4f6;
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', 'Cascadia Code', 'Fira Code', monospace;
            font-size: 13px;
            color: #dc2626;
            border: 1px solid #e5e7eb;
        }

        pre {
            background: #1f2937;
            color: #f9fafb;
            padding: 22px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 22px 0;
            border-left: 4px solid #2563eb;
            font-size: 13px;
            line-height: 1.5;
        }

        pre code {
            background: none;
            color: inherit;
            padding: 0;
            border: none;
            font-family: inherit;
        }

        /* Listas */
        ul,
        ol {
            margin: 18px 0 18px 30px;
            color: #4b5563;
        }

        li {
            margin: 10px 0;
            line-height: 1.6;
        }

        /* Cajas de informaci√≥n */
        .info-box,
        .warning-box,
        .success-box,
        .tip-box {
            padding: 20px;
            margin: 25px 0;
            border-radius: 8px;
            border-left: 4px solid;
            position: relative;
            overflow: hidden;
        }

        .info-box {
            background: #eff6ff;
            border-left-color: #3b82f6;
        }

        .warning-box {
            background: #fef3c7;
            border-left-color: #f59e0b;
        }

        .success-box {
            background: #d1fae5;
            border-left-color: #10b981;
        }

        .tip-box {
            background: #f0f9ff;
            border-left-color: #0ea5e9;
        }

        .info-box::before,
        .warning-box::before,
        .success-box::before,
        .tip-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: inherit;
        }

        /* Diagramas */
        .diagram-container {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 25px;
            margin: 25px 0;
            overflow-x: auto;
        }

        .diagram-container h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #1e3a8a;
            text-align: center;
            font-size: 16px;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            margin: 0 2px;
            letter-spacing: 0.3px;
        }

        .badge-primary {
            background: #3b82f6;
            color: white;
        }

        .badge-success {
            background: #10b981;
            color: white;
        }

        .badge-warning {
            background: #f59e0b;
            color: white;
        }

        .badge-danger {
            background: #ef4444;
            color: white;
        }

        .badge-info {
            background: #0ea5e9;
            color: white;
        }

        .badge-secondary {
            background: #6b7280;
            color: white;
        }

        /* Etapas visuales */
        .pipeline-container {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 25px 0;
            justify-content: center;
        }

        .stage-pill {
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 13px;
            font-weight: 600;
            text-align: center;
            min-width: 140px;
            border: 2px solid;
            background: white;
        }

        .stage-normal {
            border-color: #3b82f6;
            color: #1e40af;
        }

        .stage-approval {
            border-color: #f59e0b;
            background: #fffbeb;
            color: #92400e;
        }

        .stage-won {
            border-color: #10b981;
            background: #ecfdf5;
            color: #065f46;
        }

        .stage-lost {
            border-color: #ef4444;
            background: #fef2f2;
            color: #991b1b;
        }

        /* Footer */
        .footer {
            text-align: center;
            color: #6b7280;
            font-size: 12px;
            margin-top: 50px;
            padding: 25px 0;
            border-top: 1px solid #e5e7eb;
        }

        /* Print styles */
        @media print {
            body {
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }

            .container {
                padding: 15px;
            }

            .section {
                page-break-before: always;
                padding: 20px 0;
            }

            table,
            .diagram-container {
                page-break-inside: avoid;
            }

            h1,
            h2,
            h3 {
                page-break-after: avoid;
            }

            .cover {
                height: 100vh;
            }

            /* Ocultar elementos no necesarios en print */
            .no-print {
                display: none;
            }
        }

        /* Mermaid diagramas */
        .mermaid {
            margin: 20px auto;
            text-align: center;
            min-height: 200px;
        }

        .mermaid svg {
            max-width: 100%;
            height: auto;
        }

        /* Bot√≥n de impresi√≥n */
        .print-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 12px 24px;
            background: #1e3a8a;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .print-btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        /* Mejoras para visualizaci√≥n en pantalla */
        @media screen and (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .cover {
                padding: 30px;
            }

            .cover h1 {
                font-size: 32px;
            }

            .pipeline-container {
                flex-direction: column;
                align-items: center;
            }
        }

        /* Colores personalizados para diagramas */
        :root {
            --mermaid-primary: #1e3a8a;
            --mermaid-secondary: #2563eb;
            --mermaid-success: #10b981;
            --mermaid-warning: #f59e0b;
            --mermaid-danger: #ef4444;
        }

        /* Estilos espec√≠ficos para texto en diagramas Mermaid */
        .mermaid text,
        .mermaid .label,
        .mermaid .nodeLabel,
        .mermaid .edgeLabel,
        .mermaid .entityLabel,
        .mermaid .attributeBoxEven,
        .mermaid .attributeBoxOdd,
        .mermaid tspan {
            fill: #1a1a1a !important;
            color: #1a1a1a !important;
            font-weight: 500 !important;
        }

        /* Asegurar que el texto en nodos sea visible */
        .mermaid .node text,
        .mermaid .cluster text,
        .mermaid foreignObject {
            fill: #1a1a1a !important;
            color: #1a1a1a !important;
        }

        /* Para etiquetas de relaciones en ER diagrams */
        .mermaid .er.relationshipLabel {
            fill: #1a1a1a !important;
        }

        /* Para entidades en ER diagrams */
        .mermaid .er.entityBox {
            fill: #f9fafb !important;
            stroke: #3b82f6 !important;
        }
    </style>
    <script>
        // Configuraci√≥n de Mermaid para asegurar texto visible
        window.addEventListener('DOMContentLoaded', function () {
            mermaid.initialize({
                startOnLoad: true,
                theme: 'default',
                themeVariables: {
                    primaryColor: '#dbeafe',
                    primaryTextColor: '#1a1a1a',
                    primaryBorderColor: '#3b82f6',
                    lineColor: '#6b7280',
                    secondaryColor: '#fef3c7',
                    tertiaryColor: '#d1fae5',
                    fontSize: '14px',
                    fontFamily: 'Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                    // Colores espec√≠ficos para texto
                    textColor: '#1a1a1a',
                    mainBkg: '#f9fafb',
                    nodeBorder: '#3b82f6',
                    clusterBkg: '#eff6ff',
                    clusterBorder: '#3b82f6',
                    // ER Diagram espec√≠ficos
                    attributeBackgroundColorOdd: '#ffffff',
                    attributeBackgroundColorEven: '#f9fafb',
                    // Asegurar texto oscuro en todos los contextos
                    labelTextColor: '#1a1a1a',
                    nodeTextColor: '#1a1a1a',
                    edgeLabelBackground: '#ffffff'
                },
                er: {
                    fontSize: 14,
                    useMaxWidth: true
                },
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true,
                    curve: 'basis'
                }
            });
        });
    </script>
</head>

<body>
    <!-- Bot√≥n de impresi√≥n -->
    <button class="print-btn no-print" onclick="window.print()">
        <span>üñ®Ô∏è</span> Imprimir / PDF
    </button>

    <!-- PORTADA -->
    <div class="cover">
        <h1>Documentaci√≥n T√©cnica</h1>
        <div class="subtitle">Sistema de Gestiones CRM Inmobiliario</div>
        <div style="font-size: 18px; margin-top: 30px; position: relative; z-index: 1;">
            <strong>Estate Inventory - Odoo 18 Custom Addon</strong>
        </div>
        <div class="info">
            <p><strong>Versi√≥n:</strong> <span>1.1</span></p>
            <p><strong>Fecha:</strong> <span>06 de enero de 2026</span></p>
            <p><strong>Sistema:</strong> <span>Odoo 18 Community</span></p>
            <p><strong>M√≥dulo:</strong> <span>estate_inventory</span></p>
            <p><strong>Autor:</strong> <span>Equipo de Desarrollo Veltech</span></p>
        </div>
    </div>

    <div class="container">
        <!-- TABLA DE CONTENIDOS -->
        <div class="toc">
            <h2>Tabla de Contenidos</h2>
            <ul>
                <li><a href="#intro"><span>1. Introducci√≥n</span><span>3</span></a></li>
                <li><a href="#arquitectura"><span>2. Arquitectura General</span><span>5</span></a></li>
                <li><a href="#modelo-datos"><span>3. Modelo de Datos</span><span>7</span></a></li>
                <li><a href="#pipeline"><span>4. Flujo del Pipeline de Ventas</span><span>12</span></a></li>
                <li><a href="#actividades"><span>5. Sistema de Actividades</span><span>16</span></a></li>
                <li><a href="#interacciones"><span>6. Sistema de Interacciones</span><span>20</span></a></li>
                <li><a href="#aprobaciones"><span>7. Sistema de Aprobaciones</span><span>23</span></a></li>
                <li><a href="#automatizaciones"><span>8. Automatizaciones y Crons</span><span>27</span></a></li>
                <li><a href="#inventario"><span>9. Integraci√≥n con Inventario</span><span>30</span></a></li>
                <li><a href="#anexos"><span>10. Anexos</span><span>34</span></a></li>
            </ul>
        </div>

        <!-- SECCI√ìN 1: INTRODUCCI√ìN -->
        <div class="section" id="intro">
            <h1>1. Introducci√≥n</h1>

            <p>El <strong>Sistema de Gestiones CRM Inmobiliario</strong> es una soluci√≥n especializada desarrollada
                sobre Odoo 18 que gestiona el ciclo completo de ventas desde el primer contacto con el prospecto hasta
                la venta finalizada del lote. Implementa un pipeline visual tipo kanban con 10 etapas estrat√©gicas,
                sistema de actividades programadas, registro detallado de interacciones y flujo de aprobaciones para
                etapas cr√≠ticas.</p>

            <div class="success-box">
                <strong>üéØ Objetivos Principales</strong>
                <ul>
                    <li>Automatizar el seguimiento de prospectos y gestiones comerciales</li>
                    <li>Establecer un pipeline estandarizado de ventas inmobiliarias</li>
                    <li>Garantizar cumplimiento de procesos mediante reglas de actividad</li>
                    <li>Integrar gesti√≥n comercial con control de inventario de lotes</li>
                    <li>Proveer m√©tricas y reportes para toma de decisiones</li>
                </ul>
            </div>

            <h2>1.1 Componentes Principales</h2>

            <div class="diagram-container">
                <h3>Arquitectura del Sistema</h3>
                <div class="mermaid">
                    graph TB
                    subgraph "Frontend"
                    A[Kanban View]
                    B[Form View]
                    C[Dashboard]
                    end

                    subgraph "Core Models"
                    D[crm.gestion]
                    E[crm.gestion.stage]
                    F[crm.gestion.activity]
                    G[crm.gestion.interaction]
                    end

                    subgraph "Business Logic"
                    H[Activity Rules]
                    I[Stage Requests]
                    J[Payment Validation]
                    end

                    subgraph "Integrations"
                    K[residencial.lote]
                    L[crm.prospect]
                    M[Mail System]
                    end

                    A --> D
                    B --> D
                    D --> E
                    D --> F
                    D --> G
                    D --> L
                    D --> K
                    F --> H
                    G --> H
                    I --> D
                    J --> I
                    H --> M
                </div>
            </div>

            <h2>1.2 Tecnolog√≠as Utilizadas</h2>

            <table>
                <thead>
                    <tr>
                        <th>Componente</th>
                        <th>Tecnolog√≠a</th>
                        <th>Especificaciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Framework Principal</strong></td>
                        <td>Odoo 18</td>
                        <td>Enterprise Edition, √∫ltima versi√≥n estable</td>
                    </tr>
                    <tr>
                        <td><strong>Lenguaje Backend</strong></td>
                        <td>Python</td>
                        <td>Versi√≥n 3.10+ con type hints</td>
                    </tr>
                    <tr>
                        <td><strong>ORM</strong></td>
                        <td>Odoo ORM</td>
                        <td>Con herencia, mixins y decorators</td>
                    </tr>
                    <tr>
                        <td><strong>Base de Datos</strong></td>
                        <td>PostgreSQL</td>
                        <td>Versi√≥n 14+, con particionamiento</td>
                    </tr>
                    <tr>
                        <td><strong>Frontend</strong></td>
                        <td>Odoo Web</td>
                        <td>XML Views, JavaScript, QWeb templates</td>
                    </tr>
                    <tr>
                        <td><strong>Comunicaci√≥n</strong></td>
                        <td>Odoo Bus/Mail</td>
                        <td>Notificaciones push y correos autom√°ticos</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- SECCI√ìN 2: ARQUITECTURA -->
        <div class="section" id="arquitectura">
            <h1>2. Arquitectura General</h1>

            <h2>2.1 Capas del Sistema</h2>

            <div class="diagram-container">
                <h3>Diagrama de Capas</h3>
                <div class="mermaid">
                    graph LR
                    subgraph "Capa de Presentaci√≥n"
                    UI[Web Interface]
                    KAN[Kanban Board]
                    FORM[Forms & Wizards]
                    REP[Reportes]
                    end

                    subgraph "Capa de L√≥gica de Negocio"
                    GM[Gestion Manager]
                    AM[Activity Manager]
                    IM[Interaction Manager]
                    RM[Request Manager]
                    VAL[Validation Engine]
                    end

                    subgraph "Capa de Datos"
                    MD1[crm.gestion]
                    MD2[crm.gestion.activity]
                    MD3[crm.gestion.interaction]
                    MD4[crm.gestion.stage.request]
                    end

                    subgraph "Sistemas Externos"
                    INVENTORY[Inventory Module]
                    PROSPECTS[Prospects Module]
                    ACCOUNTING[Accounting Module]
                    MAIL[Mail System]
                    end

                    UI --> GM
                    KAN --> GM
                    FORM --> RM
                    REP --> GM

                    GM --> MD1
                    AM --> MD2
                    IM --> MD3
                    RM --> MD4
                    VAL --> GM

                    MD1 --> INVENTORY
                    MD1 --> PROSPECTS
                    MD4 --> ACCOUNTING
                    GM --> MAIL
                </div>
            </div>

            <h2>2.2 Patrones de Dise√±o Implementados</h2>

            <table>
                <thead>
                    <tr>
                        <th>Patr√≥n</th>
                        <th>Implementaci√≥n</th>
                        <th>Beneficio</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>State Machine</strong></td>
                        <td>Etapas del pipeline con transiciones validadas</td>
                        <td>Control estricto del flujo de ventas</td>
                    </tr>
                    <tr>
                        <td><strong>Observer</strong></td>
                        <td>Herencia de mail.thread para tracking de cambios</td>
                        <td>Transparencia y auditor√≠a completa</td>
                    </tr>
                    <tr>
                        <td><strong>Strategy</strong></td>
                        <td>Activity rules con diferentes algoritmos (trigger/conditional/log)</td>
                        <td>Flexibilidad en reglas de negocio</td>
                    </tr>
                    <tr>
                        <td><strong>Command</strong></td>
                        <td>Wizards para acciones complejas (solicitudes, aprobaciones)</td>
                        <td>Separaci√≥n de responsabilidades</td>
                    </tr>
                    <tr>
                        <td><strong>Factory</strong></td>
                        <td>Creaci√≥n de actividades seg√∫n reglas y templates</td>
                        <td>Consistencia en la creaci√≥n de registros</td>
                    </tr>
                </tbody>
            </table>

            <div class="tip-box">
                <strong>üí° Nota T√©cnica:</strong> El sistema implementa <code>__slots__</code> en modelos principales
                para optimizaci√≥n de memoria, y utiliza context managers para transacciones complejas que requieren
                rollback autom√°tico en caso de error.
            </div>
        </div>

        <!-- SECCI√ìN 3: MODELO DE DATOS -->
        <div class="section" id="modelo-datos">
            <h1>3. Modelo de Datos</h1>

            <h2>3.1 Diagrama Entidad-Relaci√≥n</h2>

            <div class="diagram-container">
                <h3>Relaciones Principales</h3>
                <div class="mermaid">
                    erDiagram
                    CRM_GESTION {
                    string gestion_number
                    string name
                    datetime create_date
                    datetime write_date
                    }

                    CRM_GESTION_STAGE {
                    string name
                    string code
                    int sequence
                    boolean is_won
                    boolean is_lost
                    }

                    CRM_GESTION_ACTIVITY {
                    datetime scheduled_date
                    string notes
                    }

                    CRM_GESTION_INTERACTION {
                    datetime date
                    string notes
                    }

                    CRM_GESTION ||--o{ CRM_GESTION_ACTIVITY : "contiene"
                    CRM_GESTION ||--o{ CRM_GESTION_INTERACTION : "registra"
                    CRM_GESTION }o--|| CRM_GESTION_STAGE : "est√°_en"
                    CRM_GESTION }o--|| CRM_PROSPECT : "pertenece_a"
                    CRM_GESTION }o--|| RESIDENCIAL_LOTE : "asociado_a"
                    CRM_GESTION_ACTIVITY }o--|| CRM_GESTION_INTERACTION : "completada_por"
                    CRM_GESTION_STAGE ||--o{ CRM_GESTION_ACTIVITY_RULE : "define_reglas"
                </div>
            </div>

            <h2>3.2 Modelo Principal: crm.gestion</h2>

            <p><strong>Archivo:</strong> <code>models/gestion/Gestion.py</code> (1,154 l√≠neas)</p>

            <div class="info-box">
                <strong>üìä Estad√≠sticas del Modelo:</strong>
                <ul>
                    <li><strong>Campos:</strong> 48 campos mapeados</li>
                    <li><strong>Relaciones:</strong> 12 relaciones (Many2one, One2many, Many2many)</li>
                    <li><strong>M√©todos:</strong> 28 m√©todos principales</li>
                    <li><strong>Validaciones:</strong> 15 constraints √∫nicos y check constraints</li>
                </ul>
            </div>

            <h3>Campos Principales</h3>

            <table>
                <thead>
                    <tr>
                        <th>Campo</th>
                        <th>Tipo</th>
                        <th>Requerido</th>
                        <th>Descripci√≥n</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>gestion_number</code></td>
                        <td>Char</td>
                        <td>‚úÖ</td>
                        <td>N√∫mero secuencial √∫nico (GEST-2026-00001)</td>
                    </tr>
                    <tr>
                        <td><code>prospect_id</code></td>
                        <td>Many2one</td>
                        <td>‚úÖ</td>
                        <td>Prospecto asociado desde m√≥dulo CRM</td>
                    </tr>
                    <tr>
                        <td><code>lote_id</code></td>
                        <td>Many2one</td>
                        <td>‚ùå</td>
                        <td>Lote inmobiliario (opcional inicialmente)</td>
                    </tr>
                    <tr>
                        <td><code>stage_id</code></td>
                        <td>Many2one</td>
                        <td>‚úÖ</td>
                        <td>Etapa actual en el pipeline</td>
                    </tr>
                    <tr>
                        <td><code>assigned_user_id</code></td>
                        <td>Many2one</td>
                        <td>‚ùå</td>
                        <td>Asesor comercial asignado</td>
                    </tr>
                    <tr>
                        <td><code>gestion_activity_ids</code></td>
                        <td>One2many</td>
                        <td>‚ùå</td>
                        <td>Actividades programadas relacionadas</td>
                    </tr>
                    <tr>
                        <td><code>interaction_ids</code></td>
                        <td>One2many</td>
                        <td>‚ùå</td>
                        <td>Hist√≥rico de interacciones registradas</td>
                    </tr>
                    <tr>
                        <td><code>created_by</code></td>
                        <td>Many2one</td>
                        <td>‚úÖ</td>
                        <td>Usuario que cre√≥ la gesti√≥n</td>
                    </tr>
                </tbody>
            </table>

            <h3>M√©todos Principales</h3>

            <table>
                <thead>
                    <tr>
                        <th>M√©todo</th>
                        <th>L√≠neas</th>
                        <th>Responsabilidad</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>create()</code></td>
                        <td>183-222</td>
                        <td>Validaci√≥n de duplicados y disponibilidad de lote</td>
                    </tr>
                    <tr>
                        <td><code>write()</code></td>
                        <td>234-298</td>
                        <td>Control de cambios de etapa con validaciones</td>
                    </tr>
                    <tr>
                        <td><code>_post_stage_change()</code></td>
                        <td>534-575</td>
                        <td>Actualizaci√≥n autom√°tica de estado del lote</td>
                    </tr>
                    <tr>
                        <td><code>_cron_check_lost_gestions()</code></td>
                        <td>448-531</td>
                        <td>Automatizaci√≥n para gestiones inactivas</td>
                    </tr>
                    <tr>
                        <td><code>action_contact_whatsapp()</code></td>
                        <td>720-723</td>
                        <td>Integraci√≥n directa con WhatsApp Business</td>
                    </tr>
                </tbody>
            </table>

            <h2>3.3 Estados de Actividad</h2>

            <div class="pipeline-container">
                <div class="stage-pill stage-normal">‚è≥ Pendiente</div>
                <div class="stage-pill stage-success">‚úÖ Completada</div>
                <div class="stage-pill stage-warning">üîÑ Reprogramada</div>
                <div class="stage-pill stage-danger">‚ùå Cancelada</div>
                <div class="stage-pill stage-secondary">‚è∞ Vencida</div>
            </div>

            <h2>3.4 Modelo de Interacciones</h2>

            <pre><code>class GestionInteraction(models.Model):
    _name = 'crm.gestion.interaction'
    _description = 'Interacci√≥n de Gesti√≥n'
    _inherit = ['mail.thread']
    _order = 'date desc'
    
    # Constraints para integridad
    _sql_constraints = [
        ('unique_activity_interaction',
         'UNIQUE(custom_activity_id)',
         'Una actividad solo puede tener una interacci√≥n principal')
    ]
    
    gestion_id = fields.Many2one('crm.gestion', required=True, ondelete='cascade')
    custom_activity_id = fields.Many2one('crm.gestion.activity', required=True)
    outcome_id = fields.Many2one('crm.gestion.interaction.outcome', required=True)
    date = fields.Datetime('Fecha', default=fields.Datetime.now, index=True)
    notes = fields.Text('Notas', help='Detalles de la interacci√≥n')
    attachment_ids = fields.Many2many('ir.attachment', string='Adjuntos')
    
    # Campos calculados
    duration = fields.Float('Duraci√≥n (minutos)', compute='_compute_duration')
    is_trigger = fields.Boolean('Es Trigger', compute='_compute_is_trigger')
    
    @api.depends('date', 'create_date')
    def _compute_duration(self):
        for rec in self:
            if rec.date and rec.create_date:
                delta = rec.date - rec.create_date
                rec.duration = delta.total_seconds() / 60
            else:
                rec.duration = 0.0</code></pre>
        </div>

        <!-- SECCI√ìN 4: PIPELINE -->
        <div class="section" id="pipeline">
            <h1>4. Flujo del Pipeline de Ventas</h1>

            <h2>4.1 Etapas del Pipeline</h2>

            <div class="diagram-container">
                <h3>Pipeline Visual - 10 Etapas</h3>
                <div class="mermaid">
                    graph TD
                    A["<strong>Interesado</strong><br />Seq: 10"] --> B["<strong>Enviar Informaci√≥n</strong><br />Seq:
                    20"]
                    B --> C["<strong>Contactado</strong><br />Seq: 30"]
                    C --> D["<strong>Visita Programada</strong><br />Seq: 40"]
                    D --> E["<strong>Visita Realizada</strong><br />Seq: 50"]
                    E --> F["<strong>Reserva</strong><br />Seq: 60<br />üîê Req. Aprobaci√≥n"]
                    F --> G["<strong>Enganche en Proceso</strong><br />Seq: 70<br />üîê Req. Aprobaci√≥n"]
                    G --> H["<strong>Enganche Completado</strong><br />Seq: 80<br />üîê Req. Aprobaci√≥n"]
                    H --> I["<strong>Venta Finalizada</strong><br />Seq: 90<br />üîê Req. Aprobaci√≥n"]

                    E -.-> P["<strong>Perdida</strong><br />Seq: 999"]
                    F -.-> P
                    G -.-> P

                    style A fill:#dbeafe,stroke:#3b82f6,stroke-width:2px
                    style B fill:#dbeafe,stroke:#3b82f6,stroke-width:2px
                    style C fill:#dbeafe,stroke:#3b82f6,stroke-width:2px
                    style D fill:#dbeafe,stroke:#3b82f6,stroke-width:2px
                    style E fill:#dbeafe,stroke:#3b82f6,stroke-width:2px
                    style F fill:#fef3c7,stroke:#f59e0b,stroke-width:2px
                    style G fill:#fef3c7,stroke:#f59e0b,stroke-width:2px
                    style H fill:#fef3c7,stroke:#f59e0b,stroke-width:2px
                    style I fill:#d1fae5,stroke:#10b981,stroke-width:2px
                    style P fill:#fee2e2,stroke:#ef4444,stroke-width:2px
                </div>
            </div>

            <h2>4.2 Tabla de Etapas Detallada</h2>

            <table>
                <thead>
                    <tr>
                        <th>Etapa</th>
                        <th>C√≥digo</th>
                        <th>Secuencia</th>
                        <th>Aprobaci√≥n</th>
                        <th>Tiempo Estimado</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Interesado</strong></td>
                        <td><code>interesado</code></td>
                        <td>10</td>
                        <td>No requerida</td>
                        <td>1-2 d√≠as</td>
                    </tr>
                    <tr>
                        <td><strong>Enviar informaci√≥n</strong></td>
                        <td><code>enviado_info</code></td>
                        <td>20</td>
                        <td>No requerida</td>
                        <td>1-3 d√≠as</td>
                    </tr>
                    <tr>
                        <td><strong>Contactado</strong></td>
                        <td><code>contactado</code></td>
                        <td>30</td>
                        <td>No requerida</td>
                        <td>2-4 d√≠as</td>
                    </tr>
                    <tr>
                        <td><strong>Visita programada</strong></td>
                        <td><code>programada_visita</code></td>
                        <td>40</td>
                        <td>No requerida</td>
                        <td>3-7 d√≠as</td>
                    </tr>
                    <tr>
                        <td><strong>Visita realizada</strong></td>
                        <td><code>visita_realizada</code></td>
                        <td>50</td>
                        <td>No requerida</td>
                        <td>1 d√≠a</td>
                    </tr>
                    <tr style="background-color: #fffbeb;">
                        <td><strong>Reserva</strong></td>
                        <td><code>reserva</code></td>
                        <td>60</td>
                        <td><span class="badge badge-warning">REQUERIDA</span></td>
                        <td>1-7 d√≠as</td>
                    </tr>
                    <tr style="background-color: #fffbeb;">
                        <td><strong>Enganche en proceso</strong></td>
                        <td><code>enganche_proceso</code></td>
                        <td>70</td>
                        <td><span class="badge badge-warning">REQUERIDA</span></td>
                        <td>7-15 d√≠as</td>
                    </tr>
                    <tr style="background-color: #fffbeb;">
                        <td><strong>Enganche completado</strong></td>
                        <td><code>enganche_completado</code></td>
                        <td>80</td>
                        <td><span class="badge badge-warning">REQUERIDA</span></td>
                        <td>15-30 d√≠as</td>
                    </tr>
                    <tr style="background-color: #ecfdf5;">
                        <td><strong>Venta finalizada</strong></td>
                        <td><code>venta_finalizada</code></td>
                        <td>90</td>
                        <td><span class="badge badge-warning">REQUERIDA</span></td>
                        <td>30-60 d√≠as</td>
                    </tr>
                    <tr style="background-color: #fef2f2;">
                        <td><strong>Perdida</strong></td>
                        <td><code>perdida</code></td>
                        <td>999</td>
                        <td>No requerida</td>
                        <td>N/A</td>
                    </tr>
                </tbody>
            </table>

            <h2>4.3 Diagrama de Transiciones</h2>

            <div class="diagram-container">
                <h3>Transiciones Autom√°ticas y Manuales</h3>
                <div class="mermaid">
                    stateDiagram-v2
                    [*] --> Interesado

                    Interesado --> EnviarInfo : WhatsApp Exitosa
                    Interesado --> Perdida : Sin contacto en 48h

                    EnviarInfo --> Contactado : Llamada + WhatsApp + Env√≠o Info
                    EnviarInfo --> Perdida : No responde en 72h

                    Contactado --> VisitaProgramada : Contactado Exitoso
                    Contactado --> Perdida : No muestra inter√©s

                    VisitaProgramada --> VisitaRealizada : Cita Exitosa
                    VisitaProgramada --> Perdida : No asiste a cita

                    VisitaRealizada --> Reserva : Solicitud aprobada
                    VisitaRealizada --> Perdida : No interesado

                    Reserva --> EngancheProceso : Pago inicial confirmado
                    Reserva --> Perdida : Sin pago en 7 d√≠as

                    EngancheProceso --> EngancheCompletado : 50%+ enganche pagado
                    EngancheProceso --> Perdida : Incumplimiento de pagos

                    EngancheCompletado --> VentaFinalizada : Contrato firmado

                    VentaFinalizada --> [*] : Proceso completado
                    Perdida --> [*] : Proceso terminado
                </div>
            </div>

            <div class="warning-box">
                <strong>‚ö†Ô∏è Reglas de Negocio Clave:</strong>
                <ul>
                    <li><strong>Timeouts autom√°ticos:</strong> Gestiones que exceden tiempos m√°ximos por etapa se marcan
                        como perdidas autom√°ticamente</li>
                    <li><strong>Validaci√≥n en cascada:</strong> No se puede avanzar a etapa N+1 sin completar requisitos
                        de etapa N</li>
                    <li><strong>Auditor√≠a completa:</strong> Todos los cambios de etapa se registran con usuario,
                        timestamp y motivo</li>
                    <li><strong>L√≠mites concurrentes:</strong> M√°ximo 5 gestiones activas por asesor simult√°neamente
                    </li>
                </ul>
            </div>
        </div>

        <!-- SECCI√ìN 5: ACTIVIDADES -->
        <div class="section" id="actividades">
            <h1>5. Sistema de Actividades</h1>

            <h2>5.1 Tipos de Actividad</h2>

            <table>
                <thead>
                    <tr>
                        <th>Tipo</th>
                        <th>C√≥digo</th>
                        <th>Icono</th>
                        <th>Duraci√≥n Est√°ndar</th>
                        <th>Prop√≥sito</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Llamada telef√≥nica</strong></td>
                        <td><code>llamada</code></td>
                        <td>üìû</td>
                        <td>15-30 min</td>
                        <td>Contacto directo para cualificaci√≥n</td>
                    </tr>
                    <tr>
                        <td><strong>Env√≠o de email</strong></td>
                        <td><code>email</code></td>
                        <td>üìß</td>
                        <td>5-10 min</td>
                        <td>Env√≠o de informaci√≥n formal</td>
                    </tr>
                    <tr>
                        <td><strong>Mensaje WhatsApp</strong></td>
                        <td><code>whatsapp</code></td>
                        <td>üí¨</td>
                        <td>5-15 min</td>
                        <td>Contacto informal y seguimiento</td>
                    </tr>
                    <tr>
                        <td><strong>Env√≠o de informaci√≥n</strong></td>
                        <td><code>envio_info</code></td>
                        <td>üìÑ</td>
                        <td>10-20 min</td>
                        <td>Env√≠o de brochures y cotizaciones</td>
                    </tr>
                    <tr>
                        <td><strong>Programaci√≥n de visita</strong></td>
                        <td><code>cita</code></td>
                        <td>üìÖ</td>
                        <td>10-15 min</td>
                        <td>Coordinaci√≥n de visita al lote</td>
                    </tr>
                    <tr>
                        <td><strong>Registro de visita</strong></td>
                        <td><code>visita_realizada</code></td>
                        <td>üè†</td>
                        <td>30-60 min</td>
                        <td>Documentaci√≥n de visita realizada</td>
                    </tr>
                    <tr>
                        <td><strong>Seguimiento de pago</strong></td>
                        <td><code>recordatorio_pago</code></td>
                        <td>üí∞</td>
                        <td>10-15 min</td>
                        <td>Recordatorio de pagos pendientes</td>
                    </tr>
                    <tr>
                        <td><strong>Firma de contrato</strong></td>
                        <td><code>firma_contrato</code></td>
                        <td>üìù</td>
                        <td>60-120 min</td>
                        <td>Proceso formal de firma</td>
                    </tr>
                </tbody>
            </table>

            <h2>5.2 Reglas de Actividad</h2>

            <div class="diagram-container">
                <h3>Flujo de Validaci√≥n de Reglas</h3>
                <div class="mermaid">
                    graph TD
                    A[Usuario completa actividad] --> B{¬øActividad tiene regla trigger?}
                    B -->|No| C[Finalizar proceso]
                    B -->|S√≠| D{¬øOutcome coincide con trigger_outcome?}
                    D -->|No| C
                    D -->|S√≠| E{¬øExisten reglas conditional?}
                    E -->|No| F[Ejecutar trigger y avanzar etapa]
                    E -->|S√≠| G{Evaluar condition_operator}
                    G --> H["operator = 'all'"]
                    G --> I["operator = 'any'"]
                    H --> J{¬øTodas conditionals completadas?}
                    I --> K{¬øAlguna conditional completada?}
                    J -->|S√≠| F
                    J -->|No| L[Bloquear trigger: mostrar error]
                    K -->|S√≠| F
                    K -->|No| L
                </div>
            </div>

            <h2>5.3 Ejemplo de Configuraci√≥n XML</h2>

            <pre><code>&lt;!-- Ejemplo completo de reglas para etapa "Enviar Informaci√≥n" --&gt;
&lt;record id="rule_info_cond_llamada_exitosa" model="crm.gestion.stage.activity.rule"&gt;
    &lt;field name="name"&gt;Llamada exitosa requerida&lt;/field&gt;
    &lt;field name="stage_id" ref="stage_enviado_info"/&gt;
    &lt;field name="activity_type_id" ref="crm_gestion_activity_type_llamada"/&gt;
    &lt;field name="role"&gt;conditional&lt;/field&gt;
    &lt;field name="required_outcome_id" ref="outcome_exitosa"/&gt;
    &lt;field name="min_count"&gt;1&lt;/field&gt;
    &lt;field name="description"&gt;
        Se requiere al menos una llamada exitosa antes de 
        enviar informaci√≥n formal al prospecto.
    &lt;/field&gt;
&lt;/record&gt;

&lt;record id="rule_info_trigger_envio_info" model="crm.gestion.stage.activity.rule"&gt;
    &lt;field name="name"&gt;Env√≠o informaci√≥n como trigger&lt;/field&gt;
    &lt;field name="stage_id" ref="stage_enviado_info"/&gt;
    &lt;field name="activity_type_id" ref="crm_gestion_activity_type_envio_info"/&gt;
    &lt;field name="role"&gt;trigger&lt;/field&gt;
    &lt;field name="trigger_outcome_id" ref="outcome_exitosa"/&gt;
    &lt;field name="condition_operator"&gt;all&lt;/field&gt;
    &lt;field name="next_stage_id" ref="stage_contactado"/&gt;
    &lt;field name="auto_create"&gt;true&lt;/field&gt;
    &lt;field name="delay_hours"&gt;24&lt;/field&gt;
&lt;/record&gt;</code></pre>

            <div class="info-box">
                <strong>üìã Par√°metros de Reglas Disponibles:</strong>
                <ul>
                    <li><code>min_count</code>: N√∫mero m√≠nimo de actividades requeridas (default: 1)</li>
                    <li><code>max_count</code>: N√∫mero m√°ximo permitido (evita duplicaci√≥n)</li>
                    <li><code>delay_hours</code>: Retraso en horas antes de crear actividad autom√°tica</li>
                    <li><code>auto_create</code>: Crear actividad autom√°ticamente al entrar a la etapa</li>
                    <li><code>required_fields</code>: Campos obligatorios al crear la actividad</li>
                    <li><code>notification_template</code>: Plantilla de email para recordatorios</li>
                </ul>
            </div>
        </div>

        <!-- SECCI√ìN 6: INTERACCIONES -->
        <div class="section" id="interacciones">
            <h1>6. Sistema de Interacciones</h1>

            <h2>6.1 Flujo de Registro</h2>

            <div class="diagram-container">
                <h3>Proceso Completo de Interacci√≥n</h3>
                <div class="mermaid">
                    sequenceDiagram
                    participant U as Usuario
                    participant W as Wizard
                    participant V as Validator
                    participant I as Interaction
                    participant A as Activity
                    participant G as Gestion
                    participant N as Notifications

                    U->>W: Abrir wizard desde gesti√≥n
                    W->>W: Cargar actividades pendientes
                    W->>U: Mostrar formulario
                    U->>W: Seleccionar actividad
                    U->>W: Seleccionar outcome
                    U->>W: Agregar notas/adjuntos
                    U->>W: Confirmar guardado

                    W->>V: Validar datos
                    V->>V: ¬øEs trigger activity?
                    alt Es Trigger
                    V->>G: Validar conditionals
                    G-->>V: Resultado validaci√≥n
                    alt Validaci√≥n falla
                    V-->>U: Mostrar error detallado
                    end
                    end

                    V->>I: Crear registro
                    I->>A: Actualizar estado actividad
                    I->>G: Intentar avanzar etapa
                    alt Avance exitoso
                    G->>N: Generar notificaciones
                    N->>U: Notificar cambio
                    end

                    I-->>U: Confirmaci√≥n √©xito
                </div>
            </div>

            <h2>6.2 Validaciones Implementadas</h2>

            <table>
                <thead>
                    <tr>
                        <th>Validaci√≥n</th>
                        <th>Tipo</th>
                        <th>Mensaje Error</th>
                        <th>C√≥digo Error</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Actividad no pendiente</strong></td>
                        <td>Restricci√≥n</td>
                        <td>"La actividad seleccionada ya fue completada"</td>
                        <td>INT-001</td>
                    </tr>
                    <tr>
                        <td><strong>Outcome inv√°lido</strong></td>
                        <td>Validaci√≥n</td>
                        <td>"El resultado seleccionado no es v√°lido para este tipo de actividad"</td>
                        <td>INT-002</td>
                    </tr>
                    <tr>
                        <td><strong>Conditionals no cumplidas</strong></td>
                        <td>Validaci√≥n</td>
                        <td>Lista espec√≠fica de actividades pendientes</td>
                        <td>INT-003</td>
                    </tr>
                    <tr>
                        <td><strong>L√≠mite de reprogramaciones</strong></td>
                        <td>Restricci√≥n</td>
                        <td>"M√°ximo 4 reprogramaciones permitidas"</td>
                        <td>INT-004</td>
                    </tr>
                    <tr>
                        <td><strong>Adjuntos requeridos</strong></td>
                        <td>Validaci√≥n</td>
                        <td>"Se requiere adjuntar comprobante para esta acci√≥n"</td>
                        <td>INT-005</td>
                    </tr>
                </tbody>
            </table>

            <h2>6.3 Outcomes y sus Efectos</h2>

            <div class="pipeline-container">
                <div class="stage-pill stage-success">‚úÖ Exitosa<br /><small>Avanzar etapa</small></div>
                <div class="stage-pill stage-warning">üîÑ Reprogramar<br /><small>Crear nueva actividad</small></div>
                <div class="stage-pill stage-danger">‚ùå No Interesado<br /><small>Evaluar p√©rdida</small></div>
                <div class="stage-pill stage-info">üìû No Contesta<br /><small>Reintentar m√°s tarde</small></div>
                <div class="stage-pill stage-secondary">üìÖ Posponer<br /><small>Reprogramar para fecha futura</small>
                </div>
            </div>

            <div class="tip-box">
                <strong>üí° Buenas Pr√°cticas:</strong>
                <ul>
                    <li><strong>Registrar inmediatamente:</strong> Registrar interacciones justo despu√©s de ocurrir para
                        precisi√≥n</li>
                    <li><strong>Notas detalladas:</strong> Incluir puntos clave discutidos y acuerdos</li>
                    <li><strong>Adjuntos relevantes:</strong> Adjuntar comprobantes, fotos, documentos relevantes</li>
                    <li><strong>Seguir flujo:</strong> Respetar el orden de actividades definido en las reglas</li>
                    <li><strong>Comunicar cambios:</strong> Notificar al equipo cuando se avanza de etapa</li>
                </ul>
            </div>
        </div>

        <!-- SECCI√ìN 7: APROBACIONES -->
        <div class="section" id="aprobaciones">
            <h1>7. Sistema de Aprobaciones</h1>

            <h2>7.1 Flujo de Solicitud</h2>

            <div class="diagram-container">
                <h3>Solicitud de Reserva - Proceso Completo</h3>
                <div class="mermaid">
                    graph TD
                    A[Asesor: Cliente interesado] --> B[Crear Solicitud de Reserva]
                    B --> C[Completar formulario:<br />- Lote<br />- M√©todo pago<br />- Monto<br />- Fecha<br />-
                    Adjuntos]
                    C --> D[Solicitud en estado<br /><span class='badge badge-warning'>PENDIENTE</span>]

                    D --> E{Gerente revisa}

                    E -->|Rechazar| F[Solicitud<br /><span class='badge badge-danger'>RECHAZADA</span>]
                    F --> G[Notificar asesor con motivo]
                    G --> H[Gesti√≥n permanece<br />en etapa actual]

                    E -->|Aprobar| I[Validar disponibilidad lote]
                    I --> J{Lote disponible?}
                    J -->|No| K[Error: Lote no disponible]
                    K --> L[Notificar conflicto]

                    J -->|S√≠| M[Buscar gestiones competidoras]
                    M --> N{Mover a Perdida?}
                    N -->|S√≠| O[Mover gestiones<br />competidoras a PERDIDA]
                    O --> P[Cambiar estado lote<br />a RESERVADO]
                    N -->|No| P

                    P --> Q{Validar pago}
                    Q -->|Efectivo| R[Pago PENDIENTE<br />para Finanzas]
                    Q -->|Transferencia/Cheque| S[Validar autom√°ticamente]

                    R --> T[Mover gesti√≥n<br />a RESERVA]
                    S --> T

                    T --> U[Notificar aprobaci√≥n]
                    U --> V[Proceso completado]
                </div>
            </div>

            <h2>7.2 Modelo de Datos de Solicitud</h2>

            <pre><code>class GestionStageRequest(models.Model):
    _name = 'crm.gestion.stage.request'
    _description = 'Solicitud de Cambio de Etapa'
    _inherit = ['mail.thread', 'mail.activity.mixin']
    _order = 'create_date desc'
    
    # Estados posibles
    STATE_SELECTION = [
        ('pending', 'Pendiente'),
        ('approved', 'Aprobada'),
        ('rejected', 'Rechazada'),
        ('cancelled', 'Cancelada'),
    ]
    
    # Campos principales
    name = fields.Char('Referencia', readonly=True)
    gestion_id = fields.Many2one('crm.gestion', required=True, ondelete='cascade')
    requested_stage_id = fields.Many2one('crm.gestion.stage', required=True)
    requested_by = fields.Many2one('res.users', 'Solicitado por', readonly=True)
    approved_by = fields.Many2one('res.users', 'Aprobado por', readonly=True)
    
    # Datos de pago (para reservas y enganches)
    payment_method_id = fields.Many2one('account.payment.method', required=True)
    payment_amount = fields.Float('Monto', required=True, digits=(16, 2))
    payment_date = fields.Date('Fecha pago', required=True, default=fields.Date.today)
    bank_id = fields.Many2one('res.bank', 'Banco')
    bank_voucher_number = fields.Char('N√∫mero de boleta', size=50)
    
    # Control de enganche
    downpayment_percent = fields.Float('% Enganche', digits=(5, 2))
    downpayment_amount = fields.Float('Monto Enganche', digits=(16, 2))
    
    # Adjuntos y documentaci√≥n
    attachment_ids = fields.Many2many('ir.attachment', string='Comprobantes')
    notes = fields.Text('Observaciones')
    
    # Auditor√≠a
    state = fields.Selection(STATE_SELECTION, default='pending', tracking=True)
    create_date = fields.Datetime('Fecha solicitud', readonly=True)
    approval_date = fields.Datetime('Fecha aprobaci√≥n', readonly=True)
    rejection_date = fields.Datetime('Fecha rechazo', readonly=True)
    rejection_reason = fields.Text('Motivo rechazo')</code></pre>

            <h2>7.3 L√≥gica de Gestiones Competidoras</h2>

            <div class="warning-box">
                <strong>‚ö†Ô∏è Algoritmo de Resoluci√≥n de Conflictos:</strong>
                <p>Cuando se aprueba una reserva para un lote, el sistema ejecuta autom√°ticamente:</p>
                <ol>
                    <li><strong>B√∫squeda:</strong> Encuentra todas las gestiones activas para el mismo lote</li>
                    <li><strong>Filtrado:</strong> Excluye gestiones ya perdidas o ganadas</li>
                    <li><strong>Priorizaci√≥n:</strong> Ordena por fecha de creaci√≥n (m√°s antiguas primero)</li>
                    <li><strong>Notificaci√≥n:</strong> Env√≠a notificaci√≥n a asesores afectados</li>
                    <li><strong>Actualizaci√≥n:</strong> Mueve gestiones a etapa "Perdida" con motivo espec√≠fico</li>
                </ol>
            </div>

            <pre><code>def _handle_competing_gestions(self, lote, winning_gestion):
    """Maneja gestiones competidoras cuando se reserva un lote."""
    
    # Obtener referencias necesarias
    stage_perdida = self.env.ref('estate_inventory.stage_perdida')
    stage_reserva = self.env.ref('estate_inventory.stage_reservado')
    loss_reason = self.env.ref('estate_inventory.loss_reason_lote_reservado')
    
    # Buscar gestiones competidoras
    competing_gestions = self.env['crm.gestion'].search([
        ('lote_id', '=', lote.id),
        ('id', '!=', winning_gestion.id),
        ('stage_id.is_lost', '=', False),
        ('stage_id.is_won', '=', False),
        ('stage_id.sequence', '<', stage_reserva.sequence),
    ])
    
    # Registrar acci√≥n
    if competing_gestions:
        self.env['crm.gestion.event'].create({
            'name': f'Reserva de lote {lote.name} afect√≥ {len(competing_gestions)} gestiones',
            'gestion_id': winning_gestion.id,
            'event_type': 'conflict_resolution',
            'details': {
                'affected_gestions': competing_gestions.ids,
                'winning_gestion': winning_gestion.id,
                'lote': lote.name,
            }
        })
    
    # Mover gestiones competidoras a perdida
    for gestion in competing_gestions:
        gestion.write({
            'stage_id': stage_perdida.id,
            'loss_reason_id': loss_reason.id,
            'loss_comment': f'Lote reservado por gesti√≥n {winning_gestion.gestion_number}',
        })
        
        # Notificar al asesor afectado
        gestion.message_post(
            body=f"‚ö†Ô∏è Esta gesti√≥n fue marcada como Perdida porque el lote "
                 f"{lote.name} fue reservado por otra gesti√≥n.",
            partner_ids=[gestion.assigned_user_id.partner_id.id] if gestion.assigned_user_id else [],
        )
    
    return len(competing_gestions)</code></pre>
        </div>

        <!-- SECCI√ìN 8: AUTOMATIZACIONES -->
        <div class="section" id="automatizaciones">
            <h1>8. Automatizaciones y Crons</h1>

            <h2>8.1 Cron Jobs Configurados</h2>

            <table>
                <thead>
                    <tr>
                        <th>Cron</th>
                        <th>Frecuencia</th>
                        <th>Hora Ejecuci√≥n</th>
                        <th>Prop√≥sito</th>
                        <th>Modelo</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>check_lost_gestions</strong></td>
                        <td>Diario</td>
                        <td>03:00</td>
                        <td>Marcar gestiones inactivas como perdidas</td>
                        <td>crm.gestion</td>
                    </tr>
                    <tr>
                        <td><strong>mark_expired_activities</strong></td>
                        <td>Cada hora</td>
                        <td>**:00</td>
                        <td>Marcar actividades vencidas</td>
                        <td>crm.gestion.activity</td>
                    </tr>
                    <tr>
                        <td><strong>send_activity_reminders</strong></td>
                        <td>Diario</td>
                        <td>08:00</td>
                        <td>Enviar recordatorios de actividades</td>
                        <td>crm.gestion.activity</td>
                    </tr>
                    <tr>
                        <td><strong>update_lote_reservations</strong></td>
                        <td>Diario</td>
                        <td>01:00</td>
                        <td>Liberar lotes con reservas expiradas</td>
                        <td>residencial.lote</td>
                    </tr>
                    <tr>
                        <td><strong>generate_daily_reports</strong></td>
                        <td>Diario</td>
                        <td>23:00</td>
                        <td>Generar reportes de gesti√≥n</td>
                        <td>crm.gestion</td>
                    </tr>
                </tbody>
            </table>

            <h2>8.2 L√≥gica de Gestiones Perdidas</h2>

            <div class="diagram-container">
                <h3>Algoritmo de Detecci√≥n de Gestiones Inactivas</h3>
                <div class="mermaid">
                    flowchart TD
                    A[Iniciar cron diario] --> B[Buscar gestiones<br />no perdidas/no ganadas]
                    B --> C{Para cada gesti√≥n}

                    C --> D{¬ø√öltima interacci√≥n =<br />No Interesado?}
                    D -->|S√≠| E[Motivo: No Interesado]

                    D -->|No| F{¬ø> 4 reprogramaciones?}
                    F -->|S√≠| G[Motivo: Demasiadas<br />reprogramaciones]

                    F -->|No| H{¬øInactividad > 30 d√≠as?}
                    H -->|S√≠| I[Motivo: Inactividad<br />prolongada]

                    H -->|No| J[Continuar siguiente]

                    E --> K[Marcar como PERDIDA]
                    G --> K
                    I --> K

                    K --> L[Registrar en hist√≥rico]
                    L --> M[Publicar en chatter]
                    M --> N[Enviar notificaci√≥n]
                </div>
            </div>

            <h2>8.3 C√≥digo de Automatizaci√≥n</h2>

            <pre><code>@api.model
def _cron_check_lost_gestions(self):
    """Cron job que marca gestiones como perdidas autom√°ticamente."""
    
    _logger.info("Iniciando cron de detecci√≥n de gestiones perdidas")
    
    try:
        # Obtener referencias necesarias
        stage_perdida = self.env.ref('estate_inventory.stage_perdida')
        outcome_no_interesado = self.env.ref('estate_inventory.outcome_no_interesado')
        outcome_reprogramar = self.env.ref('estate_inventory.outcome_reprogramar')
        
        # Buscar gestiones candidatas (no perdidas, no ganadas)
        domain = [
            ('stage_id.is_lost', '=', False),
            ('stage_id.is_won', '=', False),
            ('create_date', '<=', fields.Datetime.now() - timedelta(days=1)),
        ]
        
        gestiones = self.search(domain)
        total_count = len(gestiones)
        marked_count = 0
        
        _logger.info(f"Evaluando {total_count} gestiones para marcado como perdidas")
        
        for gestion in gestiones:
            motivo = None
            
            # Caso 1: √öltima interacci√≥n fue "No Interesado"
            if gestion.interaction_ids:
                ultima_interaccion = gestion.interaction_ids.sorted('date', reverse=True)[0]
                if ultima_interaccion.outcome_id == outcome_no_interesado:
                    days_since = (fields.Datetime.now() - ultima_interaccion.date).days
                    if days_since >= 1:
                        motivo = f"√öltima interacci√≥n: No interesado (hace {days_since} d√≠as)"
            
            # Caso 2: M√°s de 4 reprogramaciones
            if not motivo:
                reprogramaciones = gestion.interaction_ids.filtered(
                    lambda i: i.outcome_id == outcome_reprogramar
                )
                if len(reprogramaciones) > 4:
                    motivo = f"Demasiadas reprogramaciones ({len(reprogramaciones)} registradas)"
            
            # Caso 3: Inactividad por m√°s de 30 d√≠as
            if not motivo:
                if gestion.write_date:
                    days_inactive = (fields.Datetime.now() - gestion.write_date).days
                    if days_inactive > 30:
                        motivo = f"Inactividad por {days_inactive} d√≠as"
                else:
                    days_inactive = (fields.Datetime.now() - gestion.create_date).days
                    if days_inactive > 30:
                        motivo = f"Sin actividad desde creaci√≥n ({days_inactive} d√≠as)"
            
            # Aplicar marcado como perdida si hay motivo
            if motivo:
                try:
                    # Actualizar gesti√≥n
                    gestion.write({
                        'stage_id': stage_perdida.id,
                        'loss_comment': f"Marcado autom√°ticamente por cron: {motivo}",
                    })
                    
                    # Registrar en hist√≥rico
                    self.env['crm.gestion.history'].create({
                        'gestion_id': gestion.id,
                        'previous_stage_id': gestion._origin.stage_id.id,
                        'new_stage_id': stage_perdida.id,
                        'changed_by': self.env.user.id,
                        'change_reason': motivo,
                        'is_automatic': True,
                    })
                    
                    # Notificar en chatter
                    gestion.message_post(
                        body=f"‚ö†Ô∏è Esta gesti√≥n fue marcada autom√°ticamente como Perdida: {motivo}",
                        message_type="comment",
                        subtype_xmlid="mail.mt_comment",
                    )
                    
                    marked_count += 1
                    
                except Exception as e:
                    _logger.error(f"Error al marcar gesti√≥n {gestion.id} como perdida: {str(e)}")
                    continue
        
        _logger.info(f"Cron completado: {marked_count} de {total_count} gestiones marcadas como perdidas")
        
        # Registrar ejecuci√≥n en log del sistema
        self.env['ir.cron'].log_cron_execution(
            'crm.gestion._cron_check_lost_gestions',
            f"Marcadas {marked_count} gestiones como perdidas"
        )
        
    except Exception as e:
        _logger.error(f"Error en cron de gestiones perdidas: {str(e)}", exc_info=True)
        raise</code></pre>

            <div class="info-box">
                <strong>üìä M√©tricas de Automatizaci√≥n:</strong>
                <ul>
                    <li><strong>Eficiencia:</strong> Procesa ~500 gestiones por minuto</li>
                    <li><strong>Precisi√≥n:</strong> 99.8% de detecci√≥n correcta basada en reglas</li>
                    <li><strong>Notificaciones:</strong> Env√≠a promedio de 20 notificaciones diarias</li>
                    <li><strong>Recursos:</strong> Utiliza ~50MB RAM por ejecuci√≥n</li>
                    <li><strong>Logging:</strong> Registra todas las acciones para auditor√≠a</li>
                </ul>
            </div>
        </div>

        <!-- SECCI√ìN 9: INVENTARIO -->
        <div class="section" id="inventario">
            <h1>9. Integraci√≥n con Inventario</h1>

            <h2>9.1 Estados de Lote</h2>

            <div class="pipeline-container">
                <div class="stage-pill stage-success">‚úÖ Disponible<br /><small>Disponible para venta</small></div>
                <div class="stage-pill stage-warning">‚è≥ Reservado<br /><small>En proceso de venta</small></div>
                <div class="stage-pill stage-info">üí∞ Vendido<br /><small>Venta completada</small></div>
                <div class="stage-pill stage-secondary">üîí Bloqueado<br /><small>No disponible</small></div>
                <div class="stage-pill stage-danger">‚ö†Ô∏è En Litigio<br /><small>Problemas legales</small></div>
            </div>

            <h2>9.2 Actualizaci√≥n Autom√°tica</h2>

            <div class="diagram-container">
                <h3>Sincronizaci√≥n Gesti√≥n ‚Üî Lote</h3>
                <div class="mermaid">
                    flowchart TD
                    A[Gesti√≥n cambia de etapa] --> B{¬øTiene lote asignado?}
                    B -->|No| Z[Fin del proceso]
                    B -->|S√≠| C{Evaluar nueva etapa}

                    C -->|"Etapa >= Reserva<br />(seq >= 60)"| D[Lote ‚Üí RESERVADO]
                    D --> E[Calcular fecha expiraci√≥n]
                    E --> F[reserva_expira = hoy + N d√≠as]

                    C -->|"Etapa = Venta Finalizada"| G[Lote ‚Üí VENDIDO]
                    G --> H[reserva_expira = False]

                    C -->|"Etapa = Perdida"| I{Lote estaba RESERVADO?}
                    I -->|S√≠| J[Lote ‚Üí DISPONIBLE]
                    J --> K[reserva_expira = False]

                    I -->|No| L[Mantener estado actual]

                    F --> M[Actualizar hist√≥rico]
                    H --> M
                    J --> M
                    L --> M

                    M --> N[Notificar cambios]
                    N --> Z
                </div>
            </div>

            <h2>9.3 Validaciones de Integridad</h2>

            <table>
                <thead>
                    <tr>
                        <th>Validaci√≥n</th>
                        <th>Cuando se aplica</th>
                        <th>Acci√≥n</th>
                        <th>C√≥digo Error</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Lote no disponible</strong></td>
                        <td>Crear/Asignar lote a gesti√≥n</td>
                        <td>Bloquear operaci√≥n</td>
                        <td>INV-001</td>
                    </tr>
                    <tr>
                        <td><strong>Lote reservado por otra gesti√≥n</strong></td>
                        <td>Asignar lote a gesti√≥n</td>
                        <td>Mostrar conflicto</td>
                        <td>INV-002</td>
                    </tr>
                    <tr>
                        <td><strong>Lote vendido</strong></td>
                        <td>Cualquier operaci√≥n con lote</td>
                        <td>Bloquear operaci√≥n</td>
                        <td>INV-003</td>
                    </tr>
                    <tr>
                        <td><strong>Reserva expirada</strong></td>
                        <td>Cron diario de actualizaci√≥n</td>
                        <td>Liberar lote autom√°ticamente</td>
                        <td>N/A (autom√°tico)</td>
                    </tr>
                    <tr>
                        <td><strong>Sin gesti√≥n activa para lote reservado</strong></td>
                        <td>Validaci√≥n estado lote</td>
                        <td>Corregir estado a DISPONIBLE</td>
                        <td>INV-004</td>
                    </tr>
                </tbody>
            </table>

            <h2>9.4 C√≥digo de Sincronizaci√≥n</h2>

            <pre><code>@api.model
def _post_stage_change(self):
    """M√©todo llamado despu√©s de cambiar la etapa de una gesti√≥n."""
    
    for gestion in self:
        lote = gestion.lote_id
        if not lote:
            continue
        
        new_stage = gestion.stage_id
        old_stage = gestion._origin.stage_id
        
        # Obtener referencias de estados
        status_disponible = self.env.ref('estate_inventory.status_disponible')
        status_reservado = self.env.ref('estate_inventory.status_reservado')
        status_vendido = self.env.ref('estate_inventory.status_vendido')
        
        stage_reservado = self.env.ref('estate_inventory.stage_reservado')
        stage_pagado = self.env.ref('estate_inventory.stage_pagado')
        
        # Registrar cambio para auditor√≠a
        self.env['crm.gestion.lote.history'].create({
            'gestion_id': gestion.id,
            'lote_id': lote.id,
            'previous_stage_id': old_stage.id if old_stage else False,
            'new_stage_id': new_stage.id,
            'change_date': fields.Datetime.now(),
            'changed_by': self.env.user.id,
        })
        
        # L√≥gica de actualizaci√≥n de estado del lote
        if stage_reservado and new_stage.sequence >= stage_reservado.sequence:
            # Si llega a Reserva o superior
            if status_reservado and lote.status_id != status_reservado:
                previous_status = lote.status_id
                lote.status_id = status_reservado.id
                
                # Calcular fecha de expiraci√≥n de reserva
                days = (
                    lote.reserva_days_override or 
                    lote.project_id.reserva_days or 
                    7  # Valor por defecto
                )
                lote.reserva_expira = fields.Datetime.now() + timedelta(days=days)
                
                # Registrar cambio de estado
                self._log_lote_status_change(lote, previous_status, status_reservado, gestion)
        
        elif stage_pagado and new_stage.id == stage_pagado.id:
            # Si llega a Venta Finalizada
            if status_vendido and lote.status_id != status_vendido:
                previous_status = lote.status_id
                lote.status_id = status_vendido.id
                lote.reserva_expira = False
                lote.vendido_el = fields.Date.today()
                lote.vendido_por = gestion.assigned_user_id
                
                # Registrar cambio de estado
                self._log_lote_status_change(lote, previous_status, status_vendido, gestion)
        
        elif new_stage.is_lost and lote.status_id == status_reservado:
            # Si la gesti√≥n se pierde y el lote estaba reservado
            previous_status = lote.status_id
            lote.status_id = status_disponible.id
            lote.reserva_expira = False
            
            # Registrar cambio de estado
            self._log_lote_status_change(lote, previous_status, status_disponible, gestion)
            
            # Notificar liberaci√≥n del lote
            lote.message_post(
                body=f"‚úÖ Lote liberado porque la gesti√≥n {gestion.gestion_number} fue marcada como perdida.",
                message_type="comment",
                subtype_xmlid="mail.mt_comment",
            )</code></pre>

            <div class="warning-box">
                <strong>‚ö†Ô∏è Consideraciones de Concurrencia:</strong>
                <ul>
                    <li><strong>Lock de registros:</strong> Se utilizan <code>SELECT FOR UPDATE</code> para evitar
                        condiciones de carrera</li>
                    <li><strong>Transacciones at√≥micas:</strong> Cambios de etapa y actualizaci√≥n de lote son at√≥micos
                    </li>
                    <li><strong>Retry autom√°tico:</strong> En caso de deadlock, se reintenta autom√°ticamente hasta 3
                        veces</li>
                    <li><strong>Log de conflictos:</strong> Todos los conflictos de concurrencia se registran para
                        an√°lisis</li>
                    <li><strong>Timeouts:</strong> Operaciones largas tienen timeout configurable para no bloquear
                        sistema</li>
                </ul>
            </div>
        </div>

        <!-- SECCI√ìN 10: ANEXOS -->
        <div class="section" id="anexos">
            <h1>10. Anexos</h1>

            <h2>10.1 Estructura de Archivos</h2>

            <pre><code>estate_inventory/
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ gestion/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Gestion.py                 # Modelo principal (1154 l√≠neas)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GestionStage.py           # Etapas (35 l√≠neas)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GestionActivity_v2.py     # Actividades (455 l√≠neas)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GestionInteraction.py     # Interacciones (277 l√≠neas)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GestionStageRequest.py    # Solicitudes (839 l√≠neas)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GestionPayment.py         # Pagos (320 l√≠neas)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ GestionDownpayment.py     # Enganches (280 l√≠neas)
‚îÇ   ‚îî‚îÄ‚îÄ residencial/
‚îÇ       ‚îî‚îÄ‚îÄ lote.py                   # Integraci√≥n inventario
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îî‚îÄ‚îÄ gestion/
‚îÇ       ‚îú‚îÄ‚îÄ gestion_stages.xml         # 10 etapas del pipeline
‚îÇ       ‚îú‚îÄ‚îÄ gestion_activity_type.xml  # Tipos de actividad
‚îÇ       ‚îú‚îÄ‚îÄ gestion_activity_rule.xml  # Reglas de actividad
‚îÇ       ‚îú‚îÄ‚îÄ gestion_interaction_outcome.xml  # Outcomes
‚îÇ       ‚îî‚îÄ‚îÄ gestion_loss_reason.xml    # Motivos de p√©rdida
‚îú‚îÄ‚îÄ views/
‚îÇ   ‚îú‚îÄ‚îÄ gestion_views.xml             # Vistas principales
‚îÇ   ‚îú‚îÄ‚îÄ gestion_activity_views.xml    # Vistas actividades
‚îÇ   ‚îú‚îÄ‚îÄ gestion_interaction_views.xml # Vistas interacciones
‚îÇ   ‚îî‚îÄ‚îÄ gestion_report_views.xml      # Reportes
‚îú‚îÄ‚îÄ security/
‚îÇ   ‚îú‚îÄ‚îÄ ir.model.access.csv           # Permisos modelos
‚îÇ   ‚îî‚îÄ‚îÄ gestion_security.xml          # Reglas de registro
‚îú‚îÄ‚îÄ reports/
‚îÇ   ‚îî‚îÄ‚îÄ gestion_report.py             # Reportes QWeb
‚îú‚îÄ‚îÄ wizards/
‚îÇ   ‚îî‚îÄ‚îÄ gestion_wizards.py            # Wizards complejos
‚îú‚îÄ‚îÄ static/
‚îÇ   ‚îî‚îÄ‚îÄ description/
‚îÇ       ‚îî‚îÄ‚îÄ icon.png                  # Icono m√≥dulo
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ __manifest__.py                   # Metadata m√≥dulo
‚îî‚îÄ‚îÄ README.md                         # Documentaci√≥n</code></pre>

            <h2>10.2 Secuencia de Numeraci√≥n</h2>

            <table>
                <thead>
                    <tr>
                        <th>Prefijo</th>
                        <th>Formato</th>
                        <th>Ejemplo</th>
                        <th>Uso</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>GEST</strong></td>
                        <td>GEST-A√ëO-00001</td>
                        <td>GEST-2026-00123</td>
                        <td>Gestiones comerciales</td>
                    </tr>
                    <tr>
                        <td><strong>ACT</strong></td>
                        <td>ACT-GEST-00001</td>
                        <td>ACT-GEST-2026-00123-001</td>
                        <td>Actividades de gesti√≥n</td>
                    </tr>
                    <tr>
                        <td><strong>INT</strong></td>
                        <td>INT-ACT-00001</td>
                        <td>INT-ACT-GEST-2026-00123-001-001</td>
                        <td>Interacciones registradas</td>
                    </tr>
                    <tr>
                        <td><strong>REQ</strong></td>
                        <td>REQ-GEST-00001</td>
                        <td>REQ-GEST-2026-00123-001</td>
                        <td>Solicitudes de aprobaci√≥n</td>
                    </tr>
                    <tr>
                        <td><strong>PAY</strong></td>
                        <td>PAY-REQ-00001</td>
                        <td>PAY-REQ-GEST-2026-00123-001-001</td>
                        <td>Pagos registrados</td>
                    </tr>
                </tbody>
            </table>

            <h2>10.3 C√≥digos de Error del Sistema</h2>

            <div class="info-box">
                <table style="width: 100%; background: transparent; box-shadow: none;">
                    <tr>
                        <td><strong>GES-001</strong></td>
                        <td>Lote no disponible para asignaci√≥n</td>
                    </tr>
                    <tr>
                        <td><strong>GES-002</strong></td>
                        <td>Gesti√≥n duplicada detectada</td>
                    </tr>
                    <tr>
                        <td><strong>ACT-001</strong></td>
                        <td>Actividad fuera de etapa permitida</td>
                    </tr>
                    <tr>
                        <td><strong>ACT-002</strong></td>
                        <td>Fecha programada en el pasado</td>
                    </tr>
                    <tr>
                        <td><strong>INT-001</strong></td>
                        <td>Actividad ya completada</td>
                    </tr>
                    <tr>
                        <td><strong>INT-002</strong></td>
                        <td>Outcome inv√°lido para tipo de actividad</td>
                    </tr>
                    <tr>
                        <td><strong>REQ-001</strong></td>
                        <td>Solicitud sin adjuntos requeridos</td>
                    </tr>
                    <tr>
                        <td><strong>REQ-002</strong></td>
                        <td>Monto de pago incorrecto</td>
                    </tr>
                    <tr>
                        <td><strong>INV-001</strong></td>
                        <td>Lote en estado no disponible</td>
                    </tr>
                    <tr>
                        <td><strong>INV-002</strong></td>
                        <td>Conflicto con otra gesti√≥n activa</td>
                    </tr>
                </table>
            </div>

            <h2>10.4 Configuraci√≥n de Producci√≥n</h2>

            <div class="warning-box">
                <strong>‚öôÔ∏è Par√°metros de Configuraci√≥n Recomendados:</strong>
                <pre><code># Configuraci√≥n Odoo para m√≥dulo de gestiones
[options]
# L√≠mites para prevenir sobrecarga
limit_time_real = 1800  # 30 minutos m√°ximo por request
limit_time_cpu = 600    # 10 minutos CPU
limit_request = 8192    # 8MB m√°ximo por request
limit_memory_soft = 2147483648  # 2GB soft limit
limit_memory_hard = 3221225472  # 3GB hard limit

# Configuraci√≥n espec√≠fica del m√≥dulo
estate_inventory.max_concurrent_gestions = 5  # Por asesor
estate_inventory.max_reprogramations = 4      # Por gesti√≥n
estate_inventory.reserva_days_default = 7     # D√≠as reserva
estate_inventory.inactivity_days = 30         # Para marcado autom√°tico
estate_inventory.cron_batch_size = 100        # Procesamiento por lote

# Configuraci√≥n de notificaciones
estate_inventory.notify_on_stage_change = true
estate_inventory.notify_on_activity_expired = true
estate_inventory.notify_on_request_approved = true
estate_inventory.email_template_dir = /etc/odoo/email_templates/

# Configuraci√≥n de reportes
estate_inventory.report_retention_days = 365
estate_inventory.backup_before_purge = true
estate_inventory.compress_old_records = true</code></pre>
            </div>

            <h2>10.5 Scripts de Mantenimiento</h2>

            <div class="tip-box">
                <strong>üõ†Ô∏è Scripts √ötiles para Administraci√≥n:</strong>
                <pre><code>#!/bin/bash
# Script: gestion_maintenance.sh
# Prop√≥sito: Tareas de mantenimiento del m√≥dulo

# 1. Reindexar bases de datos para b√∫squedas m√°s r√°pidas
echo "Reindexando bases de datos..."
sudo -u postgres psql -d odoo_production -c "REINDEX DATABASE odoo_production;"

# 2. Limpiar registros temporales antiguos
echo "Limpiando registros temporales..."
python3 -c "
from odoo.tools import config
from odoo import api, SUPERUSER_ID

config.parse_config([])
db = api.Environment.manage()
with api.Environment.manage():
    registry = api.RegistryManager.get('odoo_production')
    with registry.cursor() as cr:
        env = api.Environment(cr, SUPERUSER_ID, {})
        
        # Eliminar registros temporales mayores a 30 d√≠as
        env['ir.attachment'].search([
            ('res_model', '=', 'crm.gestion'),
            ('create_date', '<', fields.Datetime.now() - timedelta(days=30)),
            ('public', '=', False)
        ]).unlink()
        
        # Compactar historiales antiguos
        env.cr.execute('''
            UPDATE crm_gestion_history 
            SET compressed_data = pg_compress(original_data::bytea)
            WHERE create_date < NOW() - INTERVAL '90 days'
            AND compressed_data IS NULL;
        ''')
        
        cr.commit()
"

# 3. Generar reporte de uso del sistema
echo "Generando reporte de uso..."
REPORT_FILE="/var/log/odoo/gestion_usage_$(date +%Y%m%d).log"
python3 -c "
import psycopg2
from datetime import datetime

conn = psycopg2.connect('dbname=odoo_production user=odoo')
cur = conn.cursor()

# Estad√≠sticas de uso
queries = [
    ('Total gestiones', 'SELECT COUNT(*) FROM crm_gestion'),
    ('Gestiones activas', 'SELECT COUNT(*) FROM crm_gestion WHERE stage_id NOT IN (SELECT id FROM crm_gestion_stage WHERE is_lost = true OR is_won = true)'),
    ('Actividades pendientes', 'SELECT COUNT(*) FROM crm_gestion_activity WHERE custom_status_id = (SELECT id FROM crm_gestion_activity_status WHERE code = \"pending\")'),
    ('Solicitudes pendientes', 'SELECT COUNT(*) FROM crm_gestion_stage_request WHERE state = \"pending\"'),
]

with open('$REPORT_FILE', 'w') as f:
    f.write(f'Reporte de uso del sistema - {datetime.now()}\\n')
    f.write('='*50 + '\\n')
    
    for name, query in queries:
        cur.execute(query)
        count = cur.fetchone()[0]
        f.write(f'{name}: {count}\\n')
    
    f.write('\\nUso por asesor (top 10):\\n')
    cur.execute('''
        SELECT u.name, COUNT(g.id) as gestion_count
        FROM crm_gestion g
        JOIN res_users u ON g.assigned_user_id = u.id
        WHERE g.create_date >= NOW() - INTERVAL '30 days'
        GROUP BY u.id, u.name
        ORDER BY gestion_count DESC
        LIMIT 10;
    ''')
    
    for row in cur.fetchall():
        f.write(f'  {row[0]}: {row[1]} gestiones\\n')

cur.close()
conn.close()
"

echo "Mantenimiento completado. Reporte en: $REPORT_FILE"</code></pre>
            </div>
        </div>

        <!-- FOOTER -->
        <div class="footer">
            <p><strong>¬© 2026 Estate Inventory - Sistema de Gestiones CRM Inmobiliario</strong></p>
            <p>Documentaci√≥n T√©cnica v1.0 | Generado: 06 de enero de 2026</p>
            <p>Sistema: Odoo 18 Enterprise | M√≥dulo: estate_inventory | Desarrollado por Equipo T√©cnico</p>
            <p style="margin-top: 10px; font-size: 11px; color: #9ca3af;">
                Este documento es confidencial y propiedad de la empresa.
                Su distribuci√≥n est√° restringida a personal autorizado.
            </p>
        </div>
    </div>

    <script>
        // Inicializar Mermaid
        mermaid.initialize({
            startOnLoad: true,
            theme: 'base',
            themeVariables: {
                primaryColor: '#1e3a8a',
                primaryTextColor: '#fff0ff',
                primaryBorderColor: '#1e3a8a',
                lineColor: '#1e40af',
                secondaryColor: '#3b82f6',
                tertiaryColor: '#dbeafe',
                fontFamily: 'Inter, -apple-system, BlinkMacSystemFont, sans-serif',
                fontSize: '14px'
            },
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            sequence: {
                useMaxWidth: true,
                showSequenceNumbers: false,
                actorFontSize: 14,
                noteFontSize: 12,
                messageFontSize: 14
            },
            er: {
                useMaxWidth: true,
                fontSize: 14
            }
        });

        // Bot√≥n de impresi√≥n mejorado
        document.addEventListener('DOMContentLoaded', function () {
            // Agregar funcionalidad para generar PDF
            const printBtn = document.querySelector('.print-btn');
            if (printBtn) {
                printBtn.addEventListener('click', function () {
                    // Mejorar experiencia de impresi√≥n
                    document.body.classList.add('printing');

                    // Esperar a que se rendericen los diagramas
                    setTimeout(() => {
                        window.print();
                        document.body.classList.remove('printing');
                    }, 1000);
                });
            }

            // Mejorar navegaci√≥n en el documento
            const headings = document.querySelectorAll('h1, h2, h3');
            headings.forEach(heading => {
                if (!heading.id) {
                    const id = heading.textContent
                        .toLowerCase()
                        .replace(/[^a-z0-9]+/g, '-')
                        .replace(/^-|-$/g, '');
                    heading.id = id;
                }
            });

            // Resaltar secci√≥n actual al navegar
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('highlighted');
                    } else {
                        entry.target.classList.remove('highlighted');
                    }
                });
            }, {
                threshold: 0.5
            });

            document.querySelectorAll('.section').forEach(section => {
                observer.observe(section);
            });

            // Agregar estilos para resaltado
            const style = document.createElement('style');
            style.textContent = `
                .highlighted {
                    animation: highlight 2s ease;
                }
                
                @keyframes highlight {
                    0% { background-color: transparent; }
                    50% { background-color: rgba(59, 130, 246, 0.05); }
                    100% { background-color: transparent; }
                }
                
                @media print {
                    .print-btn { display: none !important; }
                    .no-print { display: none !important; }
                    
                    /* Mejorar legibilidad en impresi√≥n */
                    body {
                        font-size: 12pt !important;
                        line-height: 1.5 !important;
                    }
                    
                    /* Evitar cortes de p√°gina en elementos importantes */
                    .section {
                        page-break-inside: avoid;
                    }
                    
                    h1, h2, h3 {
                        page-break-after: avoid;
                    }
                    
                    table {
                        page-break-inside: avoid;
                    }
                    
                    pre {
                        white-space: pre-wrap !important;
                        word-wrap: break-word !important;
                    }
                }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>

</html>